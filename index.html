<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculateur de Validation d'Ann√©e</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #001427 0%, #003057 100%);
        min-height: 100vh;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: #ffffff;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        padding: 40px;
        max-width: 800px;
        width: 100%;
      }

      h1 {
        color: #001427;
        margin-bottom: 10px;
        text-align: center;
      }

      .subtitle {
        text-align: center;
        color: #001427;
        margin-bottom: 30px;
        font-size: 14px;
        opacity: 0.7;
      }

      .import-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
      }

      .import-label {
        font-weight: bold;
        color: #001427;
        margin-bottom: 10px;
        display: block;
      }

      .import-help {
        font-size: 13px;
        color: #001427;
        margin-bottom: 10px;
        opacity: 0.7;
      }

      #pasteArea {
        width: 100%;
        min-height: 150px;
        padding: 15px;
        border: 2px dashed #001427;
        border-radius: 8px;
        font-size: 12px;
        font-family: monospace;
        resize: vertical;
      }

      #pasteArea:focus {
        outline: none;
        border-color: #dd1d2a;
        background: #fff5f5;
      }

      .import-btn {
        width: 100%;
        padding: 12px;
        background: #dd1d2a;
        color: #ffffff;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
        margin-top: 10px;
      }

      .import-btn:hover {
        background: #b91621;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }

      .stat-card.success {
        background: #d4edda;
        border: 2px solid #28a745;
      }

      .stat-card.danger {
        background: #ffe6e8;
        border: 2px solid #dd1d2a;
      }

      .stat-label {
        font-size: 12px;
        color: #001427;
        text-transform: uppercase;
        margin-bottom: 5px;
        opacity: 0.7;
      }

      .stat-value {
        font-size: 28px;
        font-weight: bold;
        color: #001427;
      }

      .modules-section {
        margin-bottom: 20px;
        max-height: 400px;
        overflow-y: auto;
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #001427;
        opacity: 0.5;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }

      .module-card {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #001427;
      }

      .module-card.valid {
        border-left-color: #28a745;
        background: #d4edda;
      }

      .module-card.invalid {
        border-left-color: #dd1d2a;
        background: #ffe6e8;
      }

      .module-card.no-grade {
        border-left-color: #6c757d;
        background: #e9ecef;
      }

      .module-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .module-name {
        font-weight: bold;
        color: #001427;
        font-size: 14px;
        flex: 1;
      }

      .module-grade {
        font-size: 20px;
        font-weight: bold;
        color: #001427;
        padding: 5px 15px;
        background: white;
        border-radius: 5px;
        min-width: 60px;
        text-align: center;
      }

      .module-details {
        font-size: 12px;
        color: #001427;
        opacity: 0.7;
        margin-top: 5px;
      }

      .exam-item {
        font-size: 11px;
        padding: 3px 0;
        color: #001427;
        opacity: 0.6;
      }

      .clear-btn {
        width: 100%;
        padding: 12px;
        background: #001427;
        color: #ffffff;
        border: none;
        border-radius: 10px;
        font-size: 14px;
        cursor: pointer;
        transition: background 0.3s;
        margin-bottom: 20px;
        opacity: 0.7;
      }

      .clear-btn:hover {
        background: #002547;
        opacity: 1;
      }

      .result {
        text-align: center;
        padding: 20px;
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
      }

      .result.success {
        background: #d4edda;
        color: #155724;
      }

      .result.danger {
        background: #ffe6e8;
        color: #dd1d2a;
      }

      .result.warning {
        background: #fff3cd;
        color: #856404;
      }

      .debug-info {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        font-size: 11px;
        color: #666;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üìö Calculateur de Validation</h1>
      <p class="subtitle">
        Minimum requis : Note C- ou sup√©rieure ‚Ä¢ 70% des modules valid√©s
      </p>

      <div class="import-section">
        <label class="import-label">üìã Importer ton relev√© de notes</label>
        <p class="import-help">
          Copie-colle TOUT ton relev√© de notes depuis le site :
        </p>
        <textarea
          id="pasteArea"
          placeholder="Colle ici ton relev√© complet..."
        ></textarea>
        <button class="import-btn" onclick="importNotes()">
          ‚ú® Importer et calculer automatiquement
        </button>
        <div class="debug-info" id="debugInfo"></div>
      </div>

      <div class="stats">
        <div class="stat-card" id="totalModulesCard">
          <div class="stat-label">Total Modules</div>
          <div class="stat-value" id="totalModules">0</div>
        </div>
        <div class="stat-card" id="validModulesCard">
          <div class="stat-label">Modules Valid√©s</div>
          <div class="stat-value" id="validModules">0</div>
        </div>
        <div class="stat-card" id="percentageCard">
          <div class="stat-label">Pourcentage</div>
          <div class="stat-value" id="percentage">0%</div>
        </div>
        <div class="stat-card" id="neededCard">
          <div class="stat-label">Encore Besoin</div>
          <div class="stat-value" id="needed">0</div>
        </div>
      </div>

      <div class="modules-section" id="modulesList">
        <div class="empty-state">
          <div class="empty-state-icon">üìù</div>
          <p>Aucun module import√©</p>
          <p style="font-size: 14px; margin-top: 10px">
            Colle ton relev√© de notes ci-dessus
          </p>
        </div>
      </div>

      <button
        class="clear-btn"
        onclick="clearAll()"
        id="clearBtn"
        style="display: none"
      >
        üóëÔ∏è Tout effacer
      </button>

      <div class="result" id="result"></div>
    </div>

    <script>
      let modules = [];

      const grades = [
        "E",
        "D-",
        "D",
        "D+",
        "C-",
        "C",
        "C+",
        "B-",
        "B",
        "B+",
        "A-",
        "A",
        "A+",
      ];
      const validGrades = ["C-", "C", "C+", "B-", "B", "B+", "A-", "A", "A+"];

      const gradeValues = {
        E: 0,
        "D-": 1,
        D: 2,
        "D+": 3,
        "C-": 4,
        C: 5,
        "C+": 6,
        "B-": 7,
        B: 8,
        "B+": 9,
        "A-": 10,
        A: 11,
        "A+": 12,
      };

      function importNotes() {
        const text = document.getElementById("pasteArea").value;
        if (!text.trim()) {
          alert("Colle d'abord ton relev√© de notes dans la zone de texte !");
          return;
        }

        const lines = text.split("\n");
        const parsedModules = [];
        let currentModule = null;
        let isHeaderLine = false;

        for (let i = 0; i < lines.length; i++) {
          const line = lines[i];

          // D√©tection d'une ligne de module (commence par un code genre IANG260)
          const moduleMatch = line.match(/^([A-Z]{4}\d{3})\s*-\s*(.+?)\t(.+)/);

          if (moduleMatch) {
            // Sauvegarder le module pr√©c√©dent
            if (currentModule) {
              parsedModules.push(currentModule);
            }

            currentModule = {
              code: moduleMatch[1],
              name: moduleMatch[2].trim(),
              professor: moduleMatch[3].trim(),
              exams: [],
            };
            isHeaderLine = false;
          }
          // Ligne d'en-t√™te (√âpreuve Date Coefficient Note)
          else if (
            line.includes("preuve") &&
            line.includes("Date") &&
            line.includes("Coefficient")
          ) {
            isHeaderLine = true;
          }
          // Ligne vide ou tiret seul
          else if (line.trim() === "-" || line.trim() === "") {
            continue;
          }
          // Ligne d'√©preuve avec note
          else if (currentModule && !isHeaderLine && line.includes("\t")) {
            const parts = line.split("\t");

            if (parts.length >= 4) {
              const examName = parts[0].trim();
              const date = parts[1].trim();
              const coef = parts[2].trim();
              const note = parts[3].trim();

              // V√©rifier si la note est valide
              if (note && note !== "-" && grades.includes(note)) {
                currentModule.exams.push({
                  name: examName || "√âvaluation",
                  date: date,
                  coefficient: parseInt(coef) || 1,
                  grade: note,
                });
              }
            }
          }
        }

        // Ajouter le dernier module
        if (currentModule) {
          parsedModules.push(currentModule);
        }

        // Calculer la note finale pour chaque module
        modules = parsedModules.map((m) => {
          let finalGrade = "-";

          if (m.exams.length > 0) {
            let totalWeighted = 0;
            let totalCoeff = 0;

            for (let exam of m.exams) {
              totalWeighted += gradeValues[exam.grade] * exam.coefficient;
              totalCoeff += exam.coefficient;
            }

            const avgValue = Math.round(totalWeighted / totalCoeff);
            finalGrade =
              Object.keys(gradeValues).find(
                (key) => gradeValues[key] === avgValue,
              ) || "C";
          }

          return {
            code: m.code,
            name: m.name,
            grade: finalGrade,
            exams: m.exams,
          };
        });

        document.getElementById("pasteArea").value = "";
        render();

        if (modules.length > 0) {
          alert(
            `‚úÖ ${modules.length} module(s) import√©(s) avec succ√®s !\n${modules.filter((m) => m.grade !== "-").length} module(s) avec des notes.`,
          );
        } else {
          alert(
            "‚ùå Aucun module trouv√©. V√©rifie que tu as bien copi√© tout le relev√©.",
          );
        }
      }

      function clearAll() {
        if (confirm("Es-tu s√ªr de vouloir tout effacer ?")) {
          modules = [];
          render();
        }
      }

      function calculate() {
        const total = modules.filter((m) => m.grade !== "-").length;
        const valid = modules.filter(
          (m) => m.grade !== "-" && validGrades.includes(m.grade),
        ).length;
        const percent = total > 0 ? Math.round((valid / total) * 100) : 0;
        const needed = Math.max(0, Math.ceil(total * 0.7) - valid);

        document.getElementById("totalModules").textContent = total;
        document.getElementById("validModules").textContent = valid;
        document.getElementById("percentage").textContent = percent + "%";
        document.getElementById("needed").textContent = needed;

        const percentCard = document.getElementById("percentageCard");
        const neededCard = document.getElementById("neededCard");
        const validCard = document.getElementById("validModulesCard");

        percentCard.className = "stat-card";
        neededCard.className = "stat-card";
        validCard.className = "stat-card";

        if (percent >= 70) {
          percentCard.classList.add("success");
          neededCard.classList.add("success");
          validCard.classList.add("success");
        } else if (total > 0) {
          percentCard.classList.add("danger");
          neededCard.classList.add("danger");
        }

        const result = document.getElementById("result");
        if (total === 0) {
          result.className = "result warning";
          result.textContent = "Importe ton relev√© de notes pour commencer !";
        } else if (percent >= 70) {
          result.className = "result success";
          result.textContent = `‚úÖ Ann√©e valid√©e ! Tu as ${percent}% de modules valid√©s (${valid}/${total})`;
        } else {
          result.className = "result danger";
          result.textContent = `‚ùå Ann√©e non valid√©e. Il te faut encore ${needed} module(s) valid√©(s) pour atteindre 70%`;
        }
      }

      function render() {
        const list = document.getElementById("modulesList");
        const clearBtn = document.getElementById("clearBtn");

        if (modules.length === 0) {
          list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>Aucun module import√©</p>
                        <p style="font-size: 14px; margin-top: 10px;">Colle ton relev√© de notes ci-dessus</p>
                    </div>
                `;
          clearBtn.style.display = "none";
        } else {
          list.innerHTML = "";
          clearBtn.style.display = "block";

          modules.forEach((module) => {
            const hasGrade = module.grade !== "-";
            const isValid = hasGrade && validGrades.includes(module.grade);
            const div = document.createElement("div");

            let cardClass = "module-card";
            if (!hasGrade) {
              cardClass += " no-grade";
            } else if (isValid) {
              cardClass += " valid";
            } else {
              cardClass += " invalid";
            }

            div.className = cardClass;

            let examsHTML = "";
            if (module.exams && module.exams.length > 0) {
              examsHTML = '<div class="module-details">';
              module.exams.forEach((exam) => {
                examsHTML += `<div class="exam-item">‚Ä¢ ${exam.name}: ${exam.grade} (coef. ${exam.coefficient})</div>`;
              });
              examsHTML += "</div>";
            } else if (!hasGrade) {
              examsHTML =
                '<div class="module-details"><div class="exam-item">Pas encore de notes</div></div>';
            }

            div.innerHTML = `
                        <div class="module-header">
                            <div class="module-name">${module.code} - ${module.name}</div>
                            <div class="module-grade">${module.grade}</div>
                        </div>
                        ${examsHTML}
                    `;

            list.appendChild(div);
          });
        }

        calculate();
      }

      render();
    </script>
  </body>
</html>
